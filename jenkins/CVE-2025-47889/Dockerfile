FROM maven:3.8.8-eclipse-temurin-17 AS builder

WORKDIR /app

RUN git clone https://github.com/jenkinsci/wso2id-oauth-plugin . \
    && git checkout 4a1a03336f8cb447e7f57cd99198b682f4084ba3

RUN mvn clean package

# ---- Stage 2: Jenkins base image with pre-installed plugin ----
FROM jenkins/jenkins:2.387.3

USER root

# Create plugins directory if missing
RUN mkdir -p /usr/share/jenkins/ref/plugins

# Copy compiled plugin from builder stage
COPY --from=builder /app/plugin/target/wso2id-oauth.hpi /usr/share/jenkins/ref/plugins/wso2id-oauth.jpi

# Set proper permissions
RUN chown -R jenkins:jenkins /usr/share/jenkins/ref/plugins

USER jenkins
