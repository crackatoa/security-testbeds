#!/bin/sh
set -e

WSO2_HOST="wso2is"
WSO2_PORT="9443"

echo "Waiting for WSO2 IS to be ready..."
until curl -k -s https://$WSO2_HOST:$WSO2_PORT/health | grep -q "UP"; do
  echo "WSO2 IS not ready yet... sleeping 5 seconds"
  sleep 5
done

echo "WSO2 IS is up!"

# Login and save cookie
curl -k -c /tmp/cookie.txt -X POST https://$WSO2_HOST:$WSO2_PORT/api/identity/user/v1.0/login \
  -H 'Content-Type: application/json' \
  -d "{\"username\":\"admin\",\"password\":\"admin\"}"

# Create SP JSON file
cat > /tmp/sp-config.json << EOF
{
  "applicationName": "JenkinsOAuth",
  "description": "OAuth2 SP for Jenkins",
  "inboundAuthenticationConfig": {
    "inboundAuthenticationRequestConfigs": [
      {
        "name": "OAuth2",
        "inboundAuthType": "oauth2",
        "properties": {
          "tokenType": "Default"
        }
      }
    ]
  }
}
EOF

# Create Service Provider and extract appId
appId=$(curl -k -b /tmp/cookie.txt -X POST https://$WSO2_HOST:$WSO2_PORT/api/server/v1/applications \
  -H 'Content-Type: application/json' \
  -d @/tmp/sp-config.json | grep -oP '(?<="id":")[^"]+')

echo "Created Service Provider with ID: $appId"

# OAuth config JSON with Jenkins callback URL
cat > /tmp/oauth-config.json << EOF
{
  "inboundAuthConfig": {
    "inboundAuthenticationRequestConfigs": [
      {
        "inboundAuthType": "oauth2",
        "properties": {
          "callbackUrl": "http://jenkins:8080/securityRealm/finishLogin",
          "grantTypes": "authorization_code refresh_token",
          "tokenScope": "openid profile email"
        }
      }
    ]
  }
}
EOF

# Update SP with OAuth details
curl -k -b /tmp/cookie.txt -X PUT https://$WSO2_HOST:$WSO2_PORT/api/server/v1/applications/$appId/inbound-auth \
  -H 'Content-Type: application/json' \
  -d @/tmp/oauth-config.json

# Get client credentials
creds=$(curl -k -b /tmp/cookie.txt https://$WSO2_HOST:$WSO2_PORT/api/server/v1/applications/$appId/inbound-auth/oauth2)

echo "OAuth Client Credentials:"
echo "$creds"
