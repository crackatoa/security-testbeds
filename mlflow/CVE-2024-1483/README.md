# MLflow Exploitation Testing Environment

## Overview
This guide provides instructions to set up a testing environment using Docker Compose and exploit it using a Python script.

## Vulnerability Description
A path traversal vulnerability exists in mlflow/mlflow version 2.9.2, allowing attackers to access arbitrary files on the server. By crafting a series of HTTP POST requests with specially crafted 'artifact_location' and 'source' parameters, using a local URI with '#' instead of '?', an attacker can traverse the server's directory structure. The issue occurs due to insufficient validation of user-supplied input in the server's handlers.

Affected versions
<= 2.9.2

Patched versions
2.12.1

## Prerequisites
- Docker and Docker Compose installed
- Python 3 installed
- `requests` module installed (`pip install requests`)

## Setting Up the MLflow Environment

1. Create a docker-compose file with the following content:


Vulnerable version:
```yaml
services:
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.9.1
    ports:
      - "5000:5000"
    command: mlflow server --host 0.0.0.0 --port 5000
```

Fixed Version:
```yaml
services:
  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.12.1
    ports:
      - "5000:5000"
    command: mlflow server --host 0.0.0.0 --port 5000
```

2. Start the MLflow server:

Vulnerable version:
```sh
docker-compose -f docker-compose-vuln.yml up -d
```

Fixed version:
```sh
docker-compose -f docker-compose-safe.yml up -d
```

3. Verify that the MLflow server is running:

```sh
curl http://127.0.0.1:5000
```

## Running the Exploitation Script

1. Save the Python script as `exploit.py`.
2. Execute the script:

```sh
python exploit.py
```

## Expected Behavior
The script will:
1. Create an experiment.
2. Create a run associated with the experiment.
3. Register a model.
4. Create a model version with an arbitrary source path.
5. Attempt to retrieve an artifact using path traversal.

The final output should contain an artifact response, potentially exposing sensitive files from the server.

## Notes
- This setup is for testing and research purposes only.
- Do not use it on production environments.
- Ensure you have permission before testing against any system.

## References
- [Huntr Security Report](https://huntr.com/bounties/52a3855d-93ff-4460-ac24-9c7e4334198d)
- [CVE-2024-1483](https://www.cve.org/CVERecord?id=CVE-2024-1483)

